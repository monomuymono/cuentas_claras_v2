AIzaSyDMhW9Fxz2kLG7HszVnBDmgQMJwzXSzd9U

https://script.google.com/macros/s/AKfycbzcp2CFlrnDnIzmRadn553OYMNYXo5AldaGdnmsisgt8O3Qm07tHj5iWGh9dCdg-leQ/exec

{
  "postData": {
    "contents": "{\"action\":\"save\",\"shareId\":\"test_session_123\",\"data\":{\"comensales\":[{\"id\":1,\"name\":\"Juan\",\"selectedItems\":[],\"total\":0}],\"availableProducts\":{},\"totalGeneralMesa\":0,\"propinaSugerida\":0,\"activeSharedInstances\":{}}}"
  }
}


{
  "action": "save",
  "shareId": "mi_id_de_prueba_app_react",
  "data": {
    "comensales": [
      {"id":1,"name":"Alice","selectedItems":[],"total":0}
    ],
    "availableProducts": {},
    "totalGeneralMesa": 10000,
    "propinaSugerida": 1000,
    "activeSharedInstances": {}
  }
}

const SPREADSHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE'; // <<-- ¡REEMPLAZA ESTO CON EL ID DE TU HOJA DE CÁLCULO!
const SHEET_NAME = 'Sessions';

// Función auxiliar para obtener la hoja de cálculo
function getSheet() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  if (!sheet) {
    throw new Error('Sheet not found: ' + SHEET_NAME + '. Make sure the sheet name is correct.');
  }
  return sheet;
}

// Función para configurar los encabezados de la hoja (ejecutar una vez manualmente desde Apps Script)
// Para ejecutar: En el editor de Apps Script, selecciona 'setupSheetHeaders' en el desplegable y haz clic en el botón 'Ejecutar' (▷).
function setupSheetHeaders() {
  try {
    const sheet = getSheet();
    if (sheet.getLastRow() < 1 || sheet.getRange("A1").getValue() !== "shareId" || sheet.getRange("B1").getValue() !== "JSON_DATA") {
      sheet.clearContents(); // Borra el contenido existente si los encabezados son incorrectos
      sheet.getRange("A1").setValue("shareId");
      sheet.getRange("B1").setValue("JSON_DATA");
      console.log("Encabezados de hoja configurados correctamente.");
    } else {
      console.log("Encabezados de hoja ya son correctos.");
    }
  } catch (e) {
    console.error("Error al configurar encabezados de hoja: " + e.message);
    throw e; // Lanza el error para mostrarlo en los registros de Apps Script
  }
}

// *** Función CLAVE para CORS: Maneja las solicitudes OPTIONS (pre-vuelo) ***
// Los navegadores envían una solicitud OPTIONS antes de las solicitudes POST/GET "complejas" (como las que tienen un Content-Type JSON).
// Esta función DEBE responder con las cabeceras CORS adecuadas.
function doOptions(e) {
  console.log("doOptions recibido."); // Descomentar para depurar
  return ContentService.createTextOutput('') // Una respuesta vacía está bien para OPTIONS
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader('Access-Control-Allow-Origin', '*') // Permite que CUALQUIER origen (dominio) acceda a tu Apps Script
    .setHeader('Access-Control-Allow-Methods', 'GET, POST, DELETE') // Define los métodos HTTP que tu script acepta
    .setHeader('Access-Control-Allow-Headers', 'Content-Type'); // Permite la cabecera Content-Type
}

// Función para manejar solicitudes GET (para cargar datos)
function doGet(e) {
  try {
    // console.log("doGet event object (e):", JSON.stringify(e)); // Descomentar para depurar

    const shareId = e && e.parameter ? e.parameter.id : undefined;

    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();

    let sessionData = null;
    if (shareId) { // Solo intenta buscar datos si se proporciona un shareId
      for (let i = 1; i < data.length; i++) { // Empieza el bucle desde la fila 1 para saltar el encabezado
        if (data[i][0] === shareId) { // shareId está en la primera columna (índice 0)
          sessionData = data[i][1]; // JSON_DATA está en la segunda columna (índice 1)
          break;
        }
      }
    }

    const output = ContentService.createTextOutput(sessionData || JSON.stringify({ message: "No data found" }))
      .setMimeType(ContentService.MimeType.JSON);
      // IMPORTANTE: setHeader debe encadenarse al ContentService.createTextOutput().setMimeType()
    output.setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS en la respuesta GET!

    return output;
  } catch (error) {
    console.error("Error en doGet:", error);
    const errorOutput = ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message || 'An unknown error occurred in doGet' }))
      .setMimeType(ContentService.MimeType.JSON);
    errorOutput.setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS en la respuesta de error GET!
    return errorOutput;
  }
}

// Función para manejar solicitudes POST (para guardar/eliminar datos)
function doPost(e) {
  try {
    // console.log("doPost event object (e):", JSON.stringify(e)); // Descomentar para depurar

    if (!e || !e.postData || !e.postData.contents) {
      console.error("doPost recibido: cuerpo de solicitud vacío o mal formado. Objeto de evento:", JSON.stringify(e));
      const errorOutput = ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No request body or malformed request. Ensure it is a POST request with Content-Type: application/json.' }))
        .setMimeType(ContentService.MimeType.JSON);
      errorOutput.setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS en la respuesta de error POST!
      return errorOutput;
    }

    const requestData = JSON.parse(e.postData.contents);
    const action = requestData.action; // 'save' o 'delete'
    const shareId = requestData.shareId;
    const dataToSave = requestData.data; // Estado completo de la aplicación para 'save'

    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();

    let response = { status: 'error', message: 'Invalid action' };

    if (action === 'save') {
      let rowFound = false;
      for (let i = 1; i < data.length; i++) { // Empieza desde la fila 1 para saltar el encabezado
        if (data[i][0] === shareId) {
          sheet.getRange(i + 1, 2).setValue(JSON.stringify(dataToSave));
          rowFound = true;
          response = { status: 'success', message: 'Data saved' };
          break;
        }
      }
      if (!rowFound) {
        // Asegúrate de que los encabezados existan si la hoja estaba vacía o los encabezados fueron eliminados manualmente
        if (sheet.getLastRow() < 1 || sheet.getRange("A1").getValue() !== "shareId") {
            sheet.appendRow(["shareId", "JSON_DATA"]);
        }
        sheet.appendRow([shareId, JSON.stringify(dataToSave)]);
        response = { status: 'success', message: 'Data saved' };
      }
    } else if (action === 'delete') {
      let rowDeleted = false;
      for (let i = 1; i < data.length; i++) { // Empieza desde la fila 1 para saltar el encabezado
        if (data[i][0] === shareId) {
          sheet.deleteRow(i + 1);
          rowDeleted = true;
          response = { status: 'success', message: rowDeleted ? 'Data deleted' : 'Data not found' };
          break;
        }
      }
    }

    const output = ContentService.createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
    output.setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS en la respuesta POST!
    return output;

  } catch (error) {
    console.error("Error en doPost:", error);
    const errorOutput = ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message || 'An unknown error occurred in doPost' }))
      .setMimeType(ContentService.MimeType.JSON);
    errorOutput.setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS en la respuesta de error POST!
    return errorOutput;
  }
}
