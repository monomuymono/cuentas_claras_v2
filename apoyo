AIzaSyDMhW9Fxz2kLG7HszVnBDmgQMJwzXSzd9U

https://script.google.com/macros/s/AKfycbzcp2CFlrnDnIzmRadn553OYMNYXo5AldaGdnmsisgt8O3Qm07tHj5iWGh9dCdg-leQ/exec

{
  "postData": {
    "contents": "{\"action\":\"save\",\"shareId\":\"test_session_123\",\"data\":{\"comensales\":[{\"id\":1,\"name\":\"Juan\",\"selectedItems\":[],\"total\":0}],\"availableProducts\":{},\"totalGeneralMesa\":0,\"propinaSugerida\":0,\"activeSharedInstances\":{}}}"
  }
}


{
  "action": "save",
  "shareId": "mi_id_de_prueba_app_react",
  "data": {
    "comensales": [
      {"id":1,"name":"Alice","selectedItems":[],"total":0}
    ],
    "availableProducts": {},
    "totalGeneralMesa": 10000,
    "propinaSugerida": 1000,
    "activeSharedInstances": {}
  }
}

const SPREADSHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE'; // <<-- ¡REEMPLAZA ESTO CON EL ID DE TU HOJA DE CÁLCULO!
const SHEET_NAME = 'Sessions';

// Función auxiliar para obtener la hoja de cálculo
function getSheet() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  if (!sheet) {
    throw new Error('Sheet not found: ' + SHEET_NAME + '. Make sure the sheet name is correct.');
  }
  return sheet;
}

// Función para configurar los encabezados de la hoja (ejecutar una vez manualmente desde Apps Script)
function setupSheetHeaders() {
  try {
    const sheet = getSheet();
    if (sheet.getLastRow() < 1 || sheet.getRange("A1").getValue() !== "shareId" || sheet.getRange("B1").getValue() !== "JSON_DATA") {
      sheet.clearContents(); // Clear existing content if headers are wrong
      sheet.getRange("A1").setValue("shareId");
      sheet.getRange("B1").setValue("JSON_DATA");
      console.log("Sheet headers set successfully.");
    } else {
      console.log("Sheet headers already correct.");
    }
  } catch (e) {
    console.error("Error setting up sheet headers: " + e.message);
    throw e; // Re-throw to show in Apps Script logs
  }
}

// Handler para las solicitudes OPTIONS (pre-vuelo CORS)
function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader('Access-Control-Allow-Origin', '*') // Permite cualquier origen
    .setHeader('Access-Control-Allow-Methods', 'GET, POST, DELETE') // Métodos permitidos
    .setHeader('Access-Control-Allow-Headers', 'Content-Type'); // Cabeceras permitidas
}

function doGet(e) {
  try {
    console.log("doGet event object (e):", JSON.stringify(e));

    const shareId = e && e.parameter ? e.parameter.id : undefined;

    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();

    let sessionData = null;
    if (shareId) {
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === shareId) {
          sessionData = data[i][1];
          break;
        }
      }
    }

    const output = ContentService.createTextOutput(sessionData || JSON.stringify({ message: "No data found" }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS!

    return output;
  } catch (error) {
    console.error("Error in doGet:", error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message || 'An unknown error occurred in doGet' }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS!
  }
}

function doPost(e) {
  try {
    console.log("doPost event object (e):", JSON.stringify(e)); // Log para depuración
    
    if (!e || !e.postData || !e.postData.contents) {
      console.error("doPost received empty or malformed request body. Event object:", JSON.stringify(e));
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No request body or malformed request. Ensure it is a POST request with Content-Type: application/json.' }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS!
    }

    const requestData = JSON.parse(e.postData.contents);
    const action = requestData.action; // 'save' or 'delete'
    const shareId = requestData.shareId;
    const dataToSave = requestData.data; // Full app state for 'save'

    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();

    let response = { status: 'error', message: 'Invalid action' };

    if (action === 'save') {
      let rowFound = false;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === shareId) {
          sheet.getRange(i + 1, 2).setValue(JSON.stringify(dataToSave));
          rowFound = true;
          response = { status: 'success', message: 'Data saved' };
          break;
        }
      }
      if (!rowFound) {
        if (sheet.getLastRow() < 1 || sheet.getRange("A1").getValue() !== "shareId") {
            sheet.appendRow(["shareId", "JSON_DATA"]);
        }
        sheet.appendRow([shareId, JSON.stringify(dataToSave)]);
        response = { status: 'success', message: 'Data saved' };
      }
    } else if (action === 'delete') {
      let rowDeleted = false;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === shareId) {
          sheet.deleteRow(i + 1);
          rowDeleted = true;
          response = { status: 'success', message: rowDeleted ? 'Data deleted' : 'Data not found' };
          break;
        }
      }
    }

    return ContentService.createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS!

  } catch (error) {
    console.error("Error in doPost:", error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message || 'An unknown error occurred in doPost' }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader('Access-Control-Allow-Origin', '*'); // ¡Importante para CORS!
  }
}
